<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOCAMA JSON Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827;
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        /* Style for the triangular marker */
        .chapter-marker-triangle {
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 15px solid;
            transform: translateX(-50%);
        }
        /* Styles for the progress bar */
        .progress-bar {
            height: 2px;
        }
        .progress-circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Custom styles for the editor's live preview window */
        #preview-card-container {
            min-height: 200px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-white mb-2">GOCAMA JSON Editor</h1>
            <p class="text-lg text-gray-400">
                Manage and update your video insights data.
            </p>
        </header>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="json-file" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded cursor-pointer transition-colors duration-200">
                        Import JSON File
                    </label>
                    <input type="file" id="json-file" accept=".json" class="hidden">
                    <span id="file-name" class="text-gray-400 truncate">No file selected</span>
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <button id="generate-colors-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200" disabled>
                        <i class="fa-solid fa-palette mr-2"></i>Generate Random Colors
                    </button>
                    <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200" disabled>
                        <i class="fa-solid fa-download mr-2"></i>Download JSON
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Edit Entries</h2>
                <div id="editor-container" class="space-y-6">
                    <p id="empty-state" class="text-center text-gray-400">Please import a JSON file to begin editing.</p>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg h-full">
                    <h2 class="text-2xl font-bold mb-4">Live Preview</h2>
                    <div id="preview-card-container">
                        <p id="preview-empty-state" class="text-center text-gray-400">Select an entry to preview.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const jsonFile = document.getElementById('json-file');
        const fileNameSpan = document.getElementById('file-name');
        const generateColorsBtn = document.getElementById('generate-colors-btn');
        const downloadBtn = document.getElementById('download-btn');
        const editorContainer = document.getElementById('editor-container');
        const emptyState = document.getElementById('empty-state');
        const previewCardContainer = document.getElementById('preview-card-container');
        const previewEmptyState = document.getElementById('preview-empty-state');

        let jsonData = [];
        let selectedPreviewIndex = null;
        let usedColors = new Set();

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };
        
        const getTextColor = (bgColor) => {
            const { r, g, b } = hexToRgb(bgColor);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? 'text-black' : 'text-white';
        };

        const generateUniqueRandomColor = () => {
            let hex;
            do {
                hex = Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0');
            } while (usedColors.has(hex));
            usedColors.add(hex);
            return `#${hex}`;
        };

        const renderEditor = () => {
            if (jsonData.length === 0) {
                emptyState.classList.remove('hidden');
                editorContainer.innerHTML = '';
                return;
            }
            emptyState.classList.add('hidden');
            editorContainer.innerHTML = '';

            jsonData.forEach((insight, index) => {
                const formGroup = document.createElement('div');
                formGroup.className = "bg-gray-700 p-4 rounded-lg flex flex-col space-y-4";
                formGroup.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-300">Entry #${index + 1}</h3>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-400">Background Color:</label>
                        <input type="color" class="w-12 h-12 rounded-lg" data-index="${index}" value="${insight.iconBgColor || '#ff6600'}">
                    </div>
                    <div>
                        <label for="topic-${index}" class="block text-gray-400 mb-1">Topic</label>
                        <input type="text" id="topic-${index}" class="w-full p-2 rounded bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring focus:ring-indigo-500" value="${insight.topic || ''}" data-field="topic" data-index="${index}">
                    </div>
                    <div>
                        <label for="answer-${index}" class="block text-gray-400 mb-1">Answer</label>
                        <textarea id="answer-${index}" rows="3" class="w-full p-2 rounded bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring focus:ring-indigo-500" data-field="answer" data-index="${index}">${insight.answer || ''}</textarea>
                    </div>
                    <div>
                        <label for="video-link-${index}" class="block text-gray-400 mb-1">Video Link</label>
                        <input type="url" id="video-link-${index}" class="w-full p-2 rounded bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring focus:ring-indigo-500" value="${insight.videoLink || ''}" data-field="videoLink" data-index="${index}">
                    </div>
                    <div>
                        <label for="duration-${index}" class="block text-gray-400 mb-1">Video Duration (seconds)</label>
                        <input type="number" id="duration-${index}" class="w-full p-2 rounded bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring focus:ring-indigo-500" value="${insight.videoDuration || ''}" data-field="videoDuration" data-index="${index}">
                    </div>
                    <button class="w-full bg-sky-600 hover:bg-sky-700 text-white py-2 px-4 rounded transition-colors duration-200 preview-btn" data-index="${index}">Preview Card</button>
                `;
                editorContainer.appendChild(formGroup);
            });
            addEventListenersToEditor();
        };

        const addEventListenersToEditor = () => {
            editorContainer.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    if (field) {
                        jsonData[index][field] = value;
                    } else if (e.target.type === 'color') {
                        jsonData[index].iconBgColor = value;
                        jsonData[index].iconTextColor = getTextColor(value);
                    }
                    if (selectedPreviewIndex === index) {
                        renderPreviewCard(jsonData[index]);
                    }
                });
            });

            editorContainer.querySelectorAll('.preview-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    selectedPreviewIndex = index;
                    renderPreviewCard(jsonData[index]);
                });
            });
        };

        const renderPreviewCard = (insight) => {
            if (!insight) {
                previewEmptyState.classList.remove('hidden');
                previewCardContainer.innerHTML = '';
                return;
            }
            previewEmptyState.classList.add('hidden');
            const { videoId, timestamp } = getVideoDetails(insight.videoLink);
            const formattedTimecode = formatTimecode(timestamp);
            const thumbnailURL = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            
            // Check for required properties to prevent errors
            const videoDuration = insight.videoDuration || 1260; 
            const iconBgColor = insight.iconBgColor || '#ff6600';
            const iconTextColor = insight.iconTextColor || 'text-black';

            // Calculate progress percentage and clamp it
            const rawProgressPercentage = (timestamp / videoDuration) * 100;
            const clampedProgressPercentage = Math.min(Math.max(rawProgressPercentage, 5), 95);
            const markerPositionStyle = `left: ${clampedProgressPercentage}%;`;

            previewCardContainer.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-lg flex flex-col transform transition-transform duration-300 hover:scale-[1.02] cursor-pointer overflow-hidden relative">
                    <div class="relative w-full pt-[56.25%] overflow-hidden">
                        <img src="${thumbnailURL}" alt="Video Thumbnail" class="absolute top-0 left-0 w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/480x270/222222/eeeeee?text=Thumbnail%20Unavailable';">
                        <div class="absolute inset-0 transition-opacity duration-300" style="background-color: ${iconBgColor}; opacity: 0.4;"></div>
                        
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="bg-black/50 w-16 h-16 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-play text-white text-3xl"></i>
                            </div>
                        </div>

                        <div class="absolute inset-x-0 bottom-4">
                            <div class="relative mx-4">
                                <div class="progress-bar w-full" style="background-color: ${iconBgColor}; opacity: 0.5;"></div>
                                <div class="progress-circle" style="background-color: ${iconBgColor}; left: 0;"></div>
                                <div class="progress-circle" style="background-color: ${iconBgColor}; right: 0;"></div>
                                <div class="absolute bottom-0 flex flex-col items-center transform -translate-x-1/2" style="${markerPositionStyle}">
                                    <div class="progress-circle" style="background-color: ${iconBgColor}; margin-bottom: 2px;"></div>
                                    <span class="text-lg font-bold text-white mb-1 bg-black py-0.5 px-2 rounded -translate-x-[17%]">${formattedTimecode}</span>
                                    <div class="chapter-marker-triangle" style="border-top-color: ${iconBgColor};"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold px-4 py-2 mb-2 rounded-lg ${iconTextColor}" style="background-color: ${iconBgColor};">${insight.topic}</h3>
                        <p class="text-gray-400 text-sm flex-grow mb-4">${insight.answer}</p>
                    </div>
                </div>
            `;
        };

        const getVideoDetails = (url) => {
            const urlObj = new URL(url);
            const videoId = urlObj.searchParams.get('v');
            const timestamp = urlObj.searchParams.get('t');
            return { videoId, timestamp: parseInt(timestamp, 10) };
        };
        
        const formatTimecode = (seconds) => {
            if (isNaN(seconds)) return '';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `(${minutes}:${remainingSeconds.toString().padStart(2, '0')})`;
        };

        jsonFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileNameSpan.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    jsonData = JSON.parse(e.target.result);
                    // Populate the usedColors set with any existing colors in the file
                    usedColors = new Set(jsonData.map(item => item.iconBgColor));
                    renderEditor();
                    generateColorsBtn.disabled = false;
                    downloadBtn.disabled = false;
                } catch (error) {
                    alert('Invalid JSON file. Please ensure it is correctly formatted.');
                    console.error('JSON parsing error:', error);
                    jsonData = [];
                    fileNameSpan.textContent = 'Invalid file';
                    generateColorsBtn.disabled = true;
                    downloadBtn.disabled = true;
                }
            };
            reader.readAsText(file);
        });

        generateColorsBtn.addEventListener('click', () => {
            // Clear used colors for this generation run to prevent issues with previous state
            usedColors.clear();
            jsonData = jsonData.map(insight => {
                const newColor = generateUniqueRandomColor();
                return {
                    ...insight,
                    iconBgColor: newColor,
                    iconTextColor: getTextColor(newColor)
                };
            });
            renderEditor();
            if (selectedPreviewIndex !== null && jsonData[selectedPreviewIndex]) {
                renderPreviewCard(jsonData[selectedPreviewIndex]);
            }
        });

        downloadBtn.addEventListener('click', () => {
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileNameSpan.textContent.replace('.json', '') + '_edited.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>