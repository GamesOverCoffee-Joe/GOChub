<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Design Consulting Study Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scroll behavior for smoother jumps */
        html {
            scroll-behavior: smooth;
        }

        /* Set a custom dark theme */
        :root {
            /* Deeper, slightly desaturated background for less eye strain */
            --bg-dark: #1a1a1a;
            /* A subtle, cool-toned highlight, not too bright */
            --highlight-light: #8cb3b3;
            /* Soft white for primary text, easy on the eyes */
            --text-primary: #e0e0e0;
            /* Muted grey for secondary text, good contrast but not distracting */
            --text-secondary: #a0a0a0;
        }

        body {
            /* Adding a subtle radial gradient for a very slight textured feel */
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at top left, #2a2a2a, #1a1a1a);
            color: var(--text-primary);
            /* Using Inter for readability, with fallbacks */
            font-family: 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6; /* Slightly increased line-height for better readability */
        }

        /* Custom scrollbar for a less obtrusive look */
        /* For WebKit browsers (Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 8px; /* For vertical scrollbars */
            height: 8px; /* For horizontal scrollbars */
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a; /* Darker track */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #555; /* Slightly lighter thumb */
            border-radius: 10px;
            border: 2px solid #2a2a2a; /* Border to make it appear thinner */
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #777; /* Lighter thumb on hover */
            }

        /* For Firefox */
        /* Note: Firefox scrollbar styling is more limited. */
        .scrollbar-thin {
            scrollbar-width: thin;
        }

        .scrollbar-thumb-gray-700 {
            scrollbar-color: #4a5568 #2a2a2a; /* thumb color track color */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

            .modal.is-active {
                display: flex; /* Flex to center content */
                opacity: 1;
            }

        .modal-content {
            background-color: var(--bg-dark);
            margin: auto;
            padding: 20px;
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            max-width: 90%; /* Responsive width */
            max-height: 90vh; /* Max height based on viewport */
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Enable scrolling for modal content */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            animation: fadeInScale 0.3s ease-out forwards; /* Animation for modal opening */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-close-btn {
            color: var(--text-secondary);
            font-size: 2.5rem; /* Larger close button */
            font-weight: bold;
            position: absolute;
            top: 10px; /* Adjusted top position */
            right: 20px; /* Adjusted right position */
            cursor: pointer;
            transition: color 0.2s;
            z-index: 1010; /* Ensure it's above other modal content */
        }

            .modal-close-btn:hover,
            .modal-close-btn:focus {
                color: var(--highlight-light);
                text-decoration: none;
                cursor: pointer;
            }

        .chevron-icon {
            transition: transform 0.2s ease-in-out;
        }

            .chevron-icon.is-open {
                transform: rotate(-180deg);
            }
    </style>
</head>
<body class="bg-[var(--bg-dark)] text-[var(--text-primary)]">
    <div class="container mx-auto p-4 md:p-8 lg:p-12 max-w-7xl">
        <header class="text-center mb-12 mt-8 md:mt-12">
            <h1 class="text-5xl md:text-6xl font-extrabold text-[var(--highlight-light)] leading-tight mb-4">
                Game Design Consulting <br class="md:hidden"> Study Guide
            </h1>
            <p class="text-[var(--text-secondary)] text-base md:text-lg mb-4 md:mb-8 max-w-3xl mx-auto">
                Welcome to my curated collection of game design consulting sessions. This guide serves as a comprehensive resource, offering insights into various facets of game development through practical examples and detailed analyses. Whether you're a seasoned developer or an aspiring designer, you'll find valuable lessons on mechanics, narrative, player experience, and more.
            </p>
            <div class="relative max-w-xl mx-auto flex items-center justify-center">
                <input type="text" id="search-input" placeholder="Search videos, tags, game titles..."
                       class="w-full p-3 pl-10 pr-4 rounded-full bg-[#2a2a2a] border border-[#444] text-white placeholder-[var(--text-secondary)] focus:outline-none focus:border-[var(--highlight-light)] transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                     class="w-5 h-5 text-[var(--text-secondary)] absolute left-3 top-1/2 -translate-y-1/2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <span id="video-count-display" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-[var(--text-secondary)] bg-[#2a2a2a] px-2 py-1 rounded-full border border-[#444] transition-opacity duration-300">
                </span>
            </div>
        </header>

        <main class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-1/4 bg-[#2a2a2a] p-6 rounded-xl shadow-lg lg:self-start lg:sticky lg:top-4">
                <h3 class="text-2xl font-bold text-white mb-6 border-b border-[#444] pb-3">Filters</h3>

                <button id="category-filter-toggle" class="lg:hidden w-full text-left p-3 rounded-xl bg-[#444] text-[var(--highlight-light)] hover:bg-[#555] transition-colors duration-200 text-lg mb-4 flex items-center justify-between">
                    Filter Categories
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 category-toggle-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>

                <nav id="category-filter-nav" class="mb-8 hidden lg:block">
                    <h4 class="text-lg font-semibold text-[var(--highlight-light)] mb-3">Categories</h4>
                    <div id="category-filter-buttons" class="space-y-2">
                    </div>
                </nav>

                <div>
                    <h4 class="text-lg font-semibold text-[var(--highlight-light)] mb-3">Tags</h4>
                    <div id="tag-filter-container" class="flex overflow-x-auto whitespace-nowrap py-2 space-x-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
                    </div>
                </div>
            </aside>

            <section id="video-sections" class="w-full lg:w-3/4">
            </section>
        </main>

        <div id="video-modal" class="modal">
            <div id="modalContent" class="modal-content w-full h-full lg:w-3/4 xl:w-2/3 2xl:w-1/2">
                <button id="modal-close-btn" class="modal-close-btn top-4 right-4">&times;</button>

                <div id="youtube-player-container" class="relative w-full overflow-hidden rounded-lg mb-6" style="padding-top: 56.25%;">
                    <iframe id="youtubeVideoPlayer" class="absolute top-0 left-0 w-full h-full"
                            src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                </div>

                <h2 id="modalTitle" class="text-3xl font-bold text-[var(--highlight-light)] mb-3"></h2>
                <p id="modalSummary" class="text-[var(--text-secondary)] mb-4"></p>

                <div id="modalTags" class="flex flex-wrap gap-2 mb-6">
                </div>

                <div id="modalGameInfo" class="mb-6 hidden">
                    <h3 class="text-xl font-bold text-white mb-2">Game Info</h3>
                    <p class="text-[var(--text-secondary)]">Game: <a id="modalGameLink" href="#" target="_blank" class="text-[var(--highlight-light)] hover:underline"></a></p>
                </div>

                <div id="modalChaptersContainer" class="mb-6 hidden">
                    <h3 class="text-xl font-bold text-white mb-4">Chapters</h3>
                    <ul id="modalChaptersList" class="space-y-3">
                    </ul>
                </div>

                <div id="modalRelatedVideosContainer" class="mb-6 hidden">
                    <h3 class="text-xl font-bold text-white mb-4">Related Videos</h3>
                    <div id="modalRelatedVideosList" class="flex overflow-x-auto space-x-4 pb-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
                    </div>
                </div>

                <div class="flex justify-between items-center mt-auto pt-4 border-t border-[#444]">
                    <button id="modal-jump-to-top-btn" class="text-[var(--highlight-light)] hover:text-white transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                        </svg>
                        Jump to Top
                    </button>
                    <button id="modal-close-btn-bottom" class="px-6 py-2 bg-[var(--highlight-light)] text-black font-semibold rounded-full hover:bg-white transition-colors duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <div id="confirmation-modal" class="modal">
            <div class="modal-content text-center p-8 max-w-md">
                <p class="text-xl font-semibold mb-6">You are about to navigate to another video. Do you want to continue?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-yes-btn" class="px-8 py-3 bg-[var(--highlight-light)] text-black font-semibold rounded-full hover:bg-white transition-colors duration-200">Yes</button>
                    <button id="confirm-no-btn" class="px-8 py-3 bg-[#444] text-white font-semibold rounded-full hover:bg-[#555] transition-colors duration-200">No</button>
                </div>
            </div>
        </div>

    </div>

    <button id="back-to-top-btn" class="
        fixed bottom-4 left-4 p-2
        bg-[#444] text-[var(--highlight-light)] rounded-full
        shadow-lg z-50
        opacity-0 transform translate-y-4
        transition-all duration-300 ease-in-out
        hover:bg-[#555] hover:scale-110
        focus:outline-none focus:ring-2 focus:ring-[var(--highlight-light)] focus:ring-opacity-75
        lg:hidden  /* Hidden on large screens and up */
    ">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
        </svg>
    </button>


    <script>let allVideos = [];
        let filteredVideos = [];
        let currentCategoryFilter = '';
        let currentTagFilter = '';
        let currentSearchTerm = ''; // Declare and initialize here

        // --- DOM Elements ---
        const videoSectionsContainer = document.getElementById('video-sections');
        const searchInput = document.getElementById('search-input');
        const videoCountDisplay = document.getElementById('video-count-display'); // New: Video count display
        const categoryFilterNav = document.getElementById('category-filter-nav');
        const categoryFilterToggle = document.getElementById('category-filter-toggle'); // New toggle button
        const categoryFilterButtonsContainer = document.getElementById('category-filter-buttons'); // New container for buttons
        const tagFilterContainer = document.getElementById('tag-filter-container');
        const backToTopBtn = document.getElementById('back-to-top-btn'); // New Back to Top button

        // Main video modal elements
        const videoModal = document.getElementById('video-modal');
        const modalContent = document.getElementById('modalContent');
        const modalCloseBtnTop = document.getElementById('modal-close-btn');
        const modalCloseBtnBottom = document.getElementById('modal-close-btn-bottom');
        const modalJumpToTopBtn = document.getElementById('modal-jump-to-top-btn');
        const youtubeVideoPlayer = document.getElementById('youtubeVideoPlayer');
        const youtubePlayerContainer = document.getElementById('youtube-player-container');
        const modalTitle = document.getElementById('modalTitle');
        const modalSummary = document.getElementById('modalSummary');
        const modalTags = document.getElementById('modalTags');
        const modalGameInfo = document.getElementById('modalGameInfo');
        const modalGameLink = document.getElementById('modalGameLink');
        const modalChaptersContainer = document.getElementById('modalChaptersContainer');
        const modalChaptersList = document.getElementById('modalChaptersList');
        const modalRelatedVideosContainer = document.getElementById('modalRelatedVideosContainer');
        const modalRelatedVideosList = document.getElementById('modalRelatedVideosList');

        // Confirmation modal elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        let relatedVideoToOpen = null; // Store data for confirmation modal

        // --- Helper Functions ---

        /** Extracts YouTube video ID from a URL */
        const getVideoId = (url) => {
            const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?.*v=|embed\/|v\/|shorts\/))([^?&#]+)/);
            return (match && match[1]) ? match[1] : null;
        };

        /** Converts MM:SS or H:MM:SS timestamp to seconds */
        const timeToSeconds = (timestamp) => {
            const parts = timestamp.split(':').map(Number);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            }
            return 0;
        };

        /** Updates the visual state of filter buttons (active/inactive) */
        const updateFilterButtonStates = () => {
            document.querySelectorAll('.category-filter-btn').forEach(button => {
                if (button.dataset.category === currentCategoryFilter) {
                    button.classList.add('bg-[#444]', 'text-[var(--highlight-light)]');
                    button.classList.remove('hover:bg-[#444]', 'text-left');
                } else {
                    button.classList.remove('bg-[#444]', 'text-[var(--highlight-light)]');
                    button.classList.add('hover:bg-[#444]', 'text-left');
                }
            });

            document.querySelectorAll('.tag-filter-btn').forEach(button => {
                if (button.dataset.tag === currentTagFilter) {
                    button.classList.add('bg-[var(--highlight-light)]', 'text-black');
                    button.classList.remove('border-[var(--highlight-light)]', 'text-[var(--highlight-light)]', 'hover:bg-[var(--highlight-light)]', 'hover:text-black');
                } else {
                    button.classList.remove('bg-[var(--highlight-light)]', 'text-black');
                    button.classList.add('border-[var(--highlight-light)]', 'text-[var(--highlight-light)]', 'hover:bg-[var(--highlight-light)]', 'hover:text-black');
                }
            });
        };

        /** Fetches video data from the JSON file */
        const fetchVideoData = async () => {
            try {
                const response = await fetch('data/consult_videos.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allVideos = await response.json();
                populateFiltersAndNav();
                applyFilters(); // Initial filter application and count update
            } catch (error) {
                console.error("Could not fetch video data:", error);
                videoSectionsContainer.innerHTML = '<p class="text-red-500 text-center text-xl mt-10">Failed to load video data. Please try again later.</p>';
                videoCountDisplay.textContent = '0 videos'; // Set count to 0 on error
            }
        };


        /** Opens the modal and populates it with video data */
        const openModal = (video) => {
            console.log('openModal called for:', video.title); // Debug log

            // Set the video source
            const videoId = getVideoId(video.videoUrl);
            if (videoId) {
                youtubeVideoPlayer.src = `https://www.youtube.com/embed/${videoId}?rel=0`; // Removed autoplay
            } else {
                console.error("Invalid YouTube URL:", video.videoUrl);
                youtubeVideoPlayer.src = "";
            }

            modalTitle.textContent = video.title;
            modalSummary.textContent = video.summary;

            // Populate tags - ADDED DEFENSIVE CHECK
            modalTags.innerHTML = (video.tags || []).map(tag => `<span class="bg-[#444] text-[var(--highlight-light)] px-3 py-1 rounded-full text-xs font-medium">${tag}</span>`).join('');

            // Handle Game Info (only if gameName exists in video object, otherwise hide)
            if (video.gameName) {
                modalGameInfo.classList.remove('hidden');
                modalGameLink.textContent = video.gameName;
                modalGameLink.href = `https://www.google.com/search?q=${encodeURIComponent(video.gameName + ' game')}`;
            } else {
                modalGameInfo.classList.add('hidden');
            }

            // Populate chapters with collapsible descriptions and "Jump to" buttons - ADDED DEFENSIVE CHECK
            modalChaptersList.innerHTML = (video.chapters || []).map((chapter, index) => `
                                    <li>
                                        <div class="flex items-center justify-between group cursor-pointer" data-collapse-toggle="chapter-description-${index}">
                                            <div class="flex items-center flex-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2 text-[var(--text-secondary)] group-hover:text-[var(--highlight-light)] transition-transform duration-200 chevron-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                                </svg>
                                                <h5 class="font-bold hover:text-[var(--highlight-light)] transition-colors duration-200">${chapter.topic}</h5>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-[var(--text-secondary)] transition-colors duration-200 mr-2">${chapter.timestamp}</span>
                                                <button class="jump-to-segment-btn text-[var(--highlight-light)] hover:text-white transition-colors duration-200"
                                                    data-timestamp="${chapter.timestamp}"
                                                    data-videoid="${videoId}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                                        <path d="M8 5v14l11-7z" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="chapter-description-${index}" class="chapter-description hidden mt-1">
                                            <p class="text-sm text-[var(--text-secondary)] ml-4 italic">Purpose: ${chapter.purpose}</p>
                                        </div>
                                    </li>
                                `).join('');

            // Add click listeners for collapsible chapters and video jump
            modalChaptersList.querySelectorAll('[data-collapse-toggle]').forEach(header => {
                const targetId = header.dataset.collapseToggle;
                const targetElement = document.getElementById(targetId);
                const chevronIcon = header.querySelector('.chevron-icon');

                header.addEventListener('click', () => {
                    const isOpen = targetElement.classList.toggle('hidden');
                    if (chevronIcon) {
                        chevronIcon.classList.toggle('is-open', !isOpen);
                    }
                });
            });

            modalChaptersList.querySelectorAll('.jump-to-segment-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent the parent container from triggering collapse
                    const videoId = event.currentTarget.dataset.videoid;
                    const timestamp = event.currentTarget.dataset.timestamp;
                    const seconds = timeToSeconds(timestamp);
                    // FIX: Added &autoplay=1 to the YouTube embed URL
                    youtubeVideoPlayer.src = `https://www.youtube.com/embed/${videoId}?start=${seconds}&rel=0&autoplay=1`;

                    // NEW: Scroll to the video player
                    youtubePlayerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            // Ensure chapters container is shown if chapters exist
            if (video.chapters && video.chapters.length > 0) {
                modalChaptersContainer.classList.remove('hidden');
            } else {
                modalChaptersContainer.classList.add('hidden');
            }

            // Populate related videos - ADDED DEFENSIVE CHECK AND NEW STRUCTURE
            modalRelatedVideosList.innerHTML = (video.related || []).map(relatedTitle => {
                // Find the full video object for the related title
                const relatedVideo = allVideos.find(v => v.title === relatedTitle);
                // Only create the button if the related video is found
                return relatedVideo ? `
                                        <button class="related-video-btn group flex-shrink-0 w-32 p-2 rounded-lg hover:bg-[#444] transition-colors duration-200 text-center"
                                                data-related-title="${relatedTitle.replace(/\s+/g, '-')}"
                                                title="Jump to ${relatedTitle}">
                                            <img src="${relatedVideo.thumbnail}" alt="${relatedVideo.title} thumbnail" class="w-full h-auto rounded-md mb-1 object-cover">
                                            <span class="text-[var(--text-secondary)] text-xs group-hover:text-[var(--highlight-light)] transition-colors duration-200 line-clamp-2">${relatedVideo.title}</span>
                                        </button>
                                    ` : ''; // Return empty string if video not found
            }).join('');


            // Add click listeners to related videos
            modalRelatedVideosList.querySelectorAll('.related-video-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    // Get the text content which holds the full title
                    const relatedTitle = event.currentTarget.querySelector('span').textContent.trim();
                    const relatedVideo = allVideos.find(v => v.title === relatedTitle);
                    if (relatedVideo) {
                        relatedVideoToOpen = { video: relatedVideo };
                        console.log('User clicked related video button. Queued:', relatedVideo.title); // Debug log
                        showConfirmationModal();
                    } else {
                        console.error('Related video not found:', relatedTitle);
                    }
                });
            });

            if (video.related && video.related.length > 0) {
                modalRelatedVideosContainer.classList.remove('hidden');
            } else {
                modalRelatedVideosContainer.classList.add('hidden');
            }

            // Show the modal - SIMPLIFIED LOGIC
            videoModal.classList.add('is-active');
            document.body.style.overflow = 'hidden';
        };

        /** Closes the main video modal - SIMPLIFIED LOGIC */
        const closeModal = () => {
            console.log('closeModal called.');
            videoModal.classList.remove('is-active');
            youtubeVideoPlayer.src = "";
            document.body.style.overflow = '';
            modalContent.scrollTo({ top: 0, behavior: 'instant' });
        };

        /** Shows the confirmation modal - SIMPLIFIED LOGIC */
        const showConfirmationModal = () => {
            console.log('Showing confirmation modal');
            confirmationModal.classList.add('is-active');
        };

        /** Hides the confirmation modal - SIMPLIFIED LOGIC */
        const hideConfirmationModal = () => {
            console.log('Hiding confirmation modal.');
            confirmationModal.classList.remove('is-active');
        };

        /** Builds and appends a video list item to its category section */
        const buildVideoListItem = (video) => {
            const item = document.createElement('div');
            item.id = `video-${video.title.replace(/\s+/g, '-')}`;
            item.className = "video-item bg-[#363636] rounded-xl shadow-lg transition-transform hover:scale-[1.01] duration-300 cursor-pointer mb-4 flex items-center p-4 lg:p-6";

            // Add thumbnail
            const thumbnailImg = document.createElement('img');
            thumbnailImg.className = "w-32 h-auto rounded-md flex-shrink-0 mr-4 lg:mr-6";
            thumbnailImg.src = video.thumbnail;
            thumbnailImg.alt = `${video.title} thumbnail`;
            item.appendChild(thumbnailImg);

            const content = document.createElement('div');
            content.className = "flex-1";
            content.innerHTML = `
                                    <h3 class="text-xl font-bold text-white mb-2">${video.title}</h3>
                                    <p class="text-[var(--text-secondary)] text-sm mb-2">${video.summary}</p>
                                    <div class="text-xs text-[var(--text-secondary)] flex flex-wrap gap-2">
                                        ${(video.tags || []).map(tag => `<span class="bg-[#444] text-[var(--highlight-light)] px-3 py-1 rounded-full text-xs font-medium">${tag}</span>`).join('')}
                                    </div>
                                `;
            item.appendChild(content);

            item.addEventListener('click', () => openModal(video));
            return item;
        };

        /** Renders all video list items, grouped by category, applying current filters */
        const renderVideos = (videosToRender) => {
            videoSectionsContainer.innerHTML = ''; // Clear existing content

            const groupedVideos = videosToRender.reduce((acc, video) => {
                if (!acc[video.category]) {
                    acc[video.category] = [];
                }
                acc[video.category].push(video);
                return acc;
            }, {});

            // Sort categories alphabetically
            const sortedCategories = Object.keys(groupedVideos).sort();

            if (videosToRender.length === 0) {
                videoSectionsContainer.innerHTML = '<p class="text-[var(--text-secondary)] text-center text-xl mt-10">No videos found matching your criteria.</p>';
            } else {
                sortedCategories.forEach(category => {
                    const section = document.createElement('section');
                    section.className = "mb-12";

                    const categoryHeading = document.createElement('h2');
                    categoryHeading.className = "text-4xl font-extrabold text-[var(--highlight-light)] mb-8 border-b-2 border-[#444] pb-4";
                    categoryHeading.textContent = category;
                    section.appendChild(categoryHeading);

                    const videoList = document.createElement('div');
                    videoList.className = "space-y-4";
                    groupedVideos[category].forEach(video => {
                        videoList.appendChild(buildVideoListItem(video));
                    });
                    section.appendChild(videoList);
                    videoSectionsContainer.appendChild(section);
                });
            }
            // Update the video count display
            videoCountDisplay.textContent = `${videosToRender.length} videos`;
        };

        /** Populates category navigation and filter dropdowns */
        const populateFiltersAndNav = () => {
            if (allVideos.length === 0) return; // Don't populate if no data

            const allCategories = [...new Set(allVideos.map(video => video.category))].sort();
            // Filter out "game design consulting" tag and get unique sorted tags
            const allTags = [...new Set(allVideos.flatMap(video => video.tags || []).filter(tag => tag.toLowerCase() !== "game design consulting"))].sort();

            // Populate Category Navigation
            categoryFilterButtonsContainer.innerHTML = ''; // Populate the new container
            // Add 'All Categories' button
            const allCategoryButton = document.createElement('button');
            allCategoryButton.textContent = 'All Categories';
            allCategoryButton.className = "category-filter-btn w-full text-left p-3 rounded-xl hover:bg-[#444] transition-colors duration-200 text-lg";
            allCategoryButton.dataset.category = ''; // Empty string for 'All'
            allCategoryButton.addEventListener('click', () => {
                currentCategoryFilter = '';
                applyFilters();
                updateFilterButtonStates();
            });
            categoryFilterButtonsContainer.appendChild(allCategoryButton);

            allCategories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = "category-filter-btn w-full text-left p-3 rounded-xl hover:bg-[#444] transition-colors duration-200 text-lg";
                button.dataset.category = category;
                button.addEventListener('click', () => {
                    currentCategoryFilter = (currentCategoryFilter === category) ? '' : category;
                    applyFilters();
                    updateFilterButtonStates();
                });
                categoryFilterButtonsContainer.appendChild(button);
            });

            // Populate Tag Filter
            tagFilterContainer.innerHTML = '';
            // Add 'All Tags' button (optional, but good for completeness)
            const allTagsButton = document.createElement('button');
            allTagsButton.textContent = 'All Tags';
            allTagsButton.className = "tag-filter-btn px-4 py-2 rounded-full border border-[var(--highlight-light)] text-[var(--highlight-light)] hover:bg-[var(--highlight-light)] hover:text-black transition-colors duration-200";
            allTagsButton.dataset.tag = ''; // Empty string for 'All'
            allTagsButton.addEventListener('click', () => {
                currentTagFilter = '';
                applyFilters();
                updateFilterButtonStates();
            });
            tagFilterContainer.appendChild(allTagsButton);

            allTags.forEach(tag => {
                const button = document.createElement('button');
                button.textContent = tag;
                button.className = "tag-filter-btn px-4 py-2 rounded-full border border-[var(--highlight-light)] text-[var(--highlight-light)] hover:bg-[var(--highlight-light)] hover:text-black transition-colors duration-200";
                button.dataset.tag = tag;
                button.addEventListener('click', () => {
                    currentTagFilter = (currentTagFilter === tag) ? '' : tag;
                    applyFilters();
                    updateFilterButtonStates();
                });
                tagFilterContainer.appendChild(button);
            });
            updateFilterButtonStates(); // Set initial state
        };

        /** Applies search and filter logic */
        const applyFilters = () => {
            // Update currentSearchTerm directly from input before filtering
            currentSearchTerm = searchInput.value.toLowerCase();

            filteredVideos = allVideos.filter(video => {
                const matchesSearch =
                    currentSearchTerm === '' ||
                    (video.title && video.title.toLowerCase().includes(currentSearchTerm)) ||
                    (video.gameName && video.gameName.toLowerCase().includes(currentSearchTerm)) ||
                    (video.summary && video.summary.toLowerCase().includes(currentSearchTerm)) ||
                    (video.tags || []).some(tag => tag.toLowerCase().includes(currentSearchTerm)) ||
                    (video.chapters || []).some(chapter =>
                        (chapter.topic && chapter.topic.toLowerCase().includes(currentSearchTerm)) ||
                        (chapter.purpose && chapter.purpose.toLowerCase().includes(currentSearchTerm)) ||
                        (chapter.flavor && chapter.flavor.toLowerCase().includes(currentSearchTerm))
                    );

                const matchesCategory = currentCategoryFilter === '' || video.category === currentCategoryFilter;
                const matchesTag = currentTagFilter === '' || (video.tags || []).includes(currentTagFilter);

                return matchesSearch && matchesCategory && matchesTag;
            });
            renderVideos(filteredVideos); // Now renderVideos also updates the count
        };

        // --- Event Listeners ---
        searchInput.addEventListener('input', applyFilters); // This will now correctly trigger filter with updated search term
        modalCloseBtnTop.addEventListener('click', closeModal);
        modalCloseBtnBottom.addEventListener('click', closeModal);
        videoModal.addEventListener('click', (event) => {
            // Close modal if user clicks on backdrop
            if (event.target === videoModal) {
                closeModal();
            }
        });

        // Event listener for the "Jump to Top" button (inside modal)
        modalJumpToTopBtn.addEventListener('click', () => {
            modalContent.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Confirmation modal buttons
        confirmYesBtn.addEventListener('click', () => {
            console.log('Confirmation "Yes" clicked. Hiding confirmation modal.');
            hideConfirmationModal();

            console.log('Attempting to close current modal...');
            closeModal();

            if (relatedVideoToOpen && relatedVideoToOpen.video) {
                console.log('Attempting to open new modal with:', relatedVideoToOpen.video.title);
                openModal(relatedVideoToOpen.video);
                relatedVideoToOpen = null;
            } else {
                console.log('Error: relatedVideoToOpen.video is null or undefined after confirmation.');
            }
        });

        confirmNoBtn.addEventListener('click', () => {
            console.log('Confirmation "No" clicked. Hiding confirmation modal.');
            hideConfirmationModal();
        });

        // Toggle category filter on small screens
        categoryFilterToggle.addEventListener('click', () => {
            const categoryNav = document.getElementById('category-filter-nav');
            const toggleIcon = categoryFilterToggle.querySelector('.category-toggle-icon');
            categoryNav.classList.toggle('hidden');
            toggleIcon.classList.toggle('rotate-180'); // Rotate icon to indicate open/close
        });

        // Toggle "Back to Top" button visibility based on scroll
        const toggleBackToTopButton = () => {
            if (window.scrollY > 300) { // Show button after 300px scroll
                backToTopBtn.classList.add('opacity-100', 'translate-y-0');
                backToTopBtn.classList.remove('opacity-0', 'translate-y-4');
            } else {
                backToTopBtn.classList.remove('opacity-100', 'translate-y-0');
                backToTopBtn.classList.add('opacity-0', 'translate-y-4');
            }
        };

        // Event listener for scrolling to trigger back-to-top button visibility
        window.addEventListener('scroll', toggleBackToTopButton);

        // Event listener for clicking the "Back to Top" button
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });


        // Initial data fetch and render when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchVideoData();
            toggleBackToTopButton(); // Check initial scroll position on load
        });</script>
</body>
</html>